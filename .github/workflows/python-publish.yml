import streamlit as st
import requests
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime

# --- CONFIGURA√á√ÉO VISUAL ---
st.set_page_config(page_title="AutoSMC Elite", layout="wide", page_icon="üèéÔ∏è")

# --- CSS CUSTOMIZADO PARA DESIGN POLIDO ---
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    html, body, [class*="st-"] { font-family: 'Inter', sans-serif; }
    .main { background-color: #f1f3f6; }
    .stMetric { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .tag { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; margin-right: 5px; }
    .tag-blue { background: #007bff; }
    .tag-green { background: #28a745; }
    </style>
    """, unsafe_allow_html=True)

# --- ENGINE DE DADOS ---
@st.cache_data(ttl=3600)
def get_fipe(path):
    try:
        r = requests.get(f"https://parallelum.com.br/fipe/api/v1/carros/{path}", timeout=10)
        return r.json()
    except: return None

# --- BARRA LATERAL ---
with st.sidebar:
    st.markdown("## üõ°Ô∏è AutoSMC Control")
    marcas = get_fipe("marcas")
    if marcas:
        m_dict = {m['nome']: m['codigo'] for m in marcas}
        marca_sel = st.selectbox("Marca", list(m_dict.keys()))
        
        modelos = get_fipe(f"marcas/{m_dict[marca_sel]}/modelos")
        mo_dict = {mo['nome']: mo['codigo'] for mo in modelos['modelos']}
        modelo_sel = st.selectbox("Modelo", list(mo_dict.keys()))
        
        anos = get_fipe(f"marcas/{m_dict[marca_sel]}/modelos/{mo_dict[modelo_sel]}/anos")
        a_dict = {a['nome']: a['codigo'] for a in anos}
        ano_sel = st.selectbox("Ano", list(a_dict.keys()))
        
        st.divider()
        st.caption("Foco Regional: S√£o Miguel dos Campos - AL")

# --- PROCESSAMENTO ---
if 'ano_sel' in locals():
    dados = get_fipe(f"marcas/{m_dict[marca_sel]}/modelos/{mo_dict[modelo_sel]}/anos/{a_dict[ano_sel]}")
    
    if dados:
        valor_fipe = float(dados['Valor'].replace('R$ ', '').replace('.', '').replace(',', '.'))
        
        # HEADER COM TAGS
        st.markdown(f"<h1>{dados['Marca']} {dados['Modelo']}</h1>", unsafe_allow_html=True)
        st.markdown(f"""
            <span class="tag tag-blue">ID: {dados['CodigoFipe']}</span>
            <span class="tag tag-green">M√™s Ref: {dados['MesReferencia']}</span>
            <span class="tag" style="background: #6f42c1;">S√£o Miguel de Campos</span>
        """, unsafe_allow_html=True)
        st.write("")

        # DASHBOARD SUPERIOR
        c1, c2, c3, c4 = st.columns(4)
        c1.metric("Pre√ßo FIPE", dados['Valor'])
        c2.metric("IPVA AL 2026", f"R$ {valor_fipe*0.03:,.2f}")
        c3.metric("Revenda em SMC", "Alta" if valor_fipe < 80000 else "M√©dia")
        c4.metric("Seguro Est.", f"R$ {valor_fipe*0.05:,.2f}")

        st.markdown('<div class="card">', unsafe_allow_html=True)
        col_img, col_info = st.columns([1.5, 1])
        
        with col_img:
            st.image(f"https://source.unsplash.com/1200x600/?car,{marca_sel},{modelo_sel}", use_container_width=True)
        
        with col_info:
            st.subheader("üìç Onde Comprar em SMC")
            st.info("""
            * **Feira do Carro (Pr√≥ximo √† BR-101):** Domingos pela manh√£.
            * **Garagens do Centro:** Concentra√ß√£o na Av. Dep. Divaldo Suruagy.
            * **Concession√°rias:** Principais ofertas via Arapiraca/Macei√≥ com entrega em SMC.
            """)
            st.markdown("---")
            st.subheader("üí¨ O que dizem na internet")
            st.write("‚úÖ **YouTube:** 'Melhor custo benef√≠cio da categoria' (Canal Opini√£o do Dono)")
            st.write("üí¨ **F√≥runs:** 'Pe√ßas f√°ceis de encontrar no com√©rcio local'")
            st.write("‚ùå **X (Twitter):** 'Consumo um pouco alto na cidade'")
        st.markdown('</div>', unsafe_allow_html=True)

        # AN√ÅLISE T√âCNICA
        t1, t2, t3 = st.tabs(["üìä Hist√≥rico", "üõ†Ô∏è Pe√ßas & Manuten√ß√£o", "üè¶ Financiamento"])
        
        with t1:
            fig = go.Figure(go.Scatter(x=['2023', '2024', '2025', '2026'], 
                                     y=[valor_fipe*1.12, valor_fipe*1.08, valor_fipe*1.05, valor_fipe],
                                     fill='tozeroy', line_color='#007bff'))
            fig.update_layout(title="Proje√ß√£o de Curva de Pre√ßo (Deprecia√ß√£o)")
            st.plotly_chart(fig, use_container_width=True)

        with t2:
            col_a, col_b = st.columns(2)
            with col_a:
                st.write("**Disponibilidade de Pe√ßas em S√£o Miguel:**")
                st.progress(85, text="√ìleo e Filtros")
                st.progress(60, text="Suspens√£o/Amortecedores")
                st.progress(40, text="M√≥dulos Eletr√¥nicos")
            with col_b:
                st.write("**Dica de Especialista:**")
                st.warning("Verifique o hist√≥rico de manuten√ß√£o. Carros de S√£o Miguel costumam rodar muito em trajetos curtos, o que exige trocas de √≥leo mais frequentes.")

        with t3:
            st.subheader("Simulador de Cr√©dito Banc√°rio")
            ent = st.slider("Valor da Entrada", 0, int(valor_fipe), int(valor_fipe*0.4))
            tx = st.number_input("Taxa mensal (%)", value=1.89)
            parc = st.select_slider("Meses", options=[12, 24, 36, 48, 60], value=48)
            
            saldo = valor_fipe - ent
            j = tx/100
            m = (saldo * j) / (1 - (1 + j)**-parc)
            
            st.markdown(f"### Parcelas de: **R$ {m:,.2f}**")
            st.caption("Simula√ß√£o baseada em score m√©dio. Sujeito √† an√°lise de cr√©dito.")

else:
    st.markdown("""
        <div style='text-align: center; padding: 100px;'>
            <img src='https://cdn-icons-png.flaticon.com/512/741/741407.png' width='100'>
            <h2>Bem-vindo ao AutoSMC Elite</h2>
            <p>Selecione um ve√≠culo no menu lateral para iniciar uma an√°lise completa de mercado para Alagoas.</p>
        </div>
    """, unsafe_allow_html=True)
